<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>sqlalchemy的使用 | 张素英的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="1. 连接数据库使用create_engine()实现连接，需要了解create_engine()各个参数的作用">
<meta property="og:type" content="article">
<meta property="og:title" content="sqlalchemy的使用">
<meta property="og:url" content="http://example.com/2019/03/03/python%E5%9F%BA%E7%A1%80/20190303_sqlchemy%E7%9A%84%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="张素英的博客">
<meta property="og:description" content="1. 连接数据库使用create_engine()实现连接，需要了解create_engine()各个参数的作用">
<meta property="og:locale">
<meta property="article:published_time" content="2019-03-03T07:24:20.000Z">
<meta property="article:modified_time" content="2020-10-17T03:28:28.000Z">
<meta property="article:author" content="Mr.zhang">
<meta property="article:tag" content="python基础">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="张素英的博客" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">张素英的博客</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-python基础/20190303_sqlchemy的使用" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/03/03/python%E5%9F%BA%E7%A1%80/20190303_sqlchemy%E7%9A%84%E4%BD%BF%E7%94%A8/" class="article-date">
  <time class="dt-published" datetime="2019-03-03T07:24:20.000Z" itemprop="datePublished">2019-03-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/python/">python</a>►<a class="article-category-link" href="/categories/python/python%E5%9F%BA%E7%A1%80/">python基础</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      sqlalchemy的使用
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="1-连接数据库"><a href="#1-连接数据库" class="headerlink" title="1. 连接数据库"></a>1. 连接数据库</h4><p>使用create_engine()实现连接，需要了解create_engine()各个参数的作用</p>
<span id="more"></span>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 连接数据库</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line">engine = create_engine(</span><br><span class="line">    <span class="string">&quot;mysql+pymysql://root:1990@localhost:3306/crawl_test?charset=utf8&quot;</span>,</span><br><span class="line">    echo=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h4 id="2-创建数据表"><a href="#2-创建数据表" class="headerlink" title="2. 创建数据表"></a>2. 创建数据表</h4><p>定义实体映射类数据表结构，通过操作类属性从而操作数据表字段</p>
<p>创建表结构的方式<br>创建一个自增的数字主键！！！：不需要特意的设定，SQLAlchemy will automatically set the first Integer PK column that’s not marked as a FK as autoincrement=True</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建数据表方法一</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String, DateTime</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mytable</span>(<span class="params">Base</span>):</span></span><br><span class="line">    <span class="comment"># 表名</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;mytable&#x27;</span></span><br><span class="line">    <span class="comment"># 字段，属性</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">50</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    age = Column(Integer)</span><br><span class="line">    birth = Column(DateTime)</span><br><span class="line">    class_name = Column(String(<span class="number">50</span>))</span><br><span class="line"></span><br><span class="line">Base.metadata.create_all(engine)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建数据表方法二</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, MetaData, ForeignKey, Table</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.dialects.mysql <span class="keyword">import</span> (INTEGER, CHAR)</span><br><span class="line">meta = MetaData()</span><br><span class="line">myclass = Table(<span class="string">&#x27;myclass&#x27;</span>, meta,</span><br><span class="line">                Column(<span class="string">&#x27;id&#x27;</span>, INTEGER, primary_key=<span class="literal">True</span>),</span><br><span class="line">                Column(<span class="string">&#x27;name&#x27;</span>, CHAR(<span class="number">50</span>), ForeignKey(mytable.name)),</span><br><span class="line">                Column(<span class="string">&#x27;class_name&#x27;</span>, CHAR(<span class="number">50</span>))</span><br><span class="line">                )</span><br><span class="line">myclass.create(bind=engine)</span><br></pre></td></tr></table></figure>

<p>删除数据表：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除数据表</span></span><br><span class="line">StudentItem.drop(bind=engine)</span><br><span class="line">Base.metadata.drop_all(engine)</span><br></pre></td></tr></table></figure>

<h4 id="3-创建持久化对象"><a href="#3-创建持久化对象" class="headerlink" title="3. 创建持久化对象"></a>3. 创建持久化对象</h4><p>引入sessionmaker模块，绑定已连接数据库的engin对象，生成会话对象session</p>
<h4 id="4-添加数据"><a href="#4-添加数据" class="headerlink" title="4. 添加数据"></a>4. 添加数据</h4><p>对实体类的属性赋值，通过session.add()方法添加数据，通过session.commit()方法提交数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">new_data = mytable(name=<span class="string">&#x27;Li Lei&#x27;</span>,age=<span class="number">10</span>,birth=<span class="string">&#x27;2017-10-01&#x27;</span>,class_name=<span class="string">&#x27;一年级一班&#x27;</span>)</span><br><span class="line">session.add(new_data)</span><br><span class="line">session.commit()</span><br><span class="line">session.close()</span><br></pre></td></tr></table></figure>

<h4 id="5-更新数据"><a href="#5-更新数据" class="headerlink" title="5. 更新数据"></a>5. 更新数据</h4><p>先查询需要修改的数据对象再更新，更新方法有修改对象属性值 和 使用update()方法更新数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">session.query(mytable).filter_by(<span class="built_in">id</span>=<span class="number">1</span>).update(&#123; mytable.age : <span class="number">12</span>&#125;)</span><br><span class="line">session.commit()</span><br><span class="line">session.close()</span><br></pre></td></tr></table></figure>

<h4 id="6-删除数据"><a href="#6-删除数据" class="headerlink" title="6. 删除数据"></a>6. 删除数据</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">session.query(mytable).filter_by(<span class="built_in">id</span>=<span class="number">1</span>).delete()</span><br><span class="line">session.commit()</span><br><span class="line">session.close()</span><br></pre></td></tr></table></figure>


<h4 id="7-查询数据"><a href="#7-查询数据" class="headerlink" title="7. 查询数据"></a>7. 查询数据</h4><p>filter_by相当于SQL语句里面的where判断;<br>join相当于SQL语句中的inner join ;<br>outerjoin相当于full outer join ;</p>
<p>1、查询myclass全部数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询myclass全部数据，相当于select * from myclass;</span></span><br><span class="line"><span class="comment"># all()是将数据以列表的形式返回</span></span><br><span class="line">get_data = session.query(myclass).<span class="built_in">all</span>()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> get_data:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;我的名字是：&#x27;</span> + i.name)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;我的班级是：&#x27;</span> + i.class_name)</span><br><span class="line">session.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询某些字段，相当于select name, class_name from myclass;</span></span><br><span class="line">get_data = session.query(myclass.name, myclass.class_name).<span class="built_in">all</span>()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> get_data:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;我的名字是：&#x27;</span> + i.name)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;我的班级是：&#x27;</span> + i.class_name)</span><br><span class="line">session.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2、设置筛选条件<br>filter和filter_by</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据条件查询某条数据</span></span><br><span class="line"><span class="comment"># 筛选方法一：</span></span><br><span class="line"><span class="comment"># get_data = session.query(myclass).filter(myclass.id==1).all()</span></span><br><span class="line"><span class="comment"># 筛选方法二：</span></span><br><span class="line">get_data = session.query(myclass).filter_by(<span class="built_in">id</span>=<span class="number">1</span>).<span class="built_in">all</span>()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;数据类型是：&#x27;</span> + <span class="built_in">str</span>(<span class="built_in">type</span>(get_data)))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> get_data:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;我的名字是：&#x27;</span> + i.name)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;我的班级是：&#x27;</span> + i.class_name)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>把all()换成first()可以查询1条数据：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询id为1的数据</span></span><br><span class="line">single_stu = session.query(StudentItem).filter_by(stu_id=stu_id).first()</span><br></pre></td></tr></table></figure>

<p>3、设置多筛选条件：</p>
<p>带and的查询，如：select * from mytable where id&gt;1 and class_name=’三年级二班’，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">get_data = session.query(mytable).<span class="built_in">filter</span>(mytable.<span class="built_in">id</span> &gt;= <span class="number">2</span>, </span><br><span class="line">             mytable.class_name == <span class="string">&#x27;三年级二班&#x27;</span>).first()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;数据类型是：&#x27;</span> + <span class="built_in">str</span>(<span class="built_in">type</span>(get_data)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;我的名字是：&#x27;</span> + get_data.name)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;我的班级是：&#x27;</span> + get_data.class_name)</span><br></pre></td></tr></table></figure>
<p>带or的查询，如：select * from mytable where id&gt;1 and class_name=’三年级二班’，代码如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> or_</span><br><span class="line">get_data = session.query(mytable).<span class="built_in">filter</span>(or_(mytable.<span class="built_in">id</span> &gt;= <span class="number">2</span>,</span><br><span class="line">                                         mytable.class_name == <span class="string">&#x27;三年级二班&#x27;</span>)).<span class="built_in">all</span>()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;数据类型是：&#x27;</span> + <span class="built_in">str</span>(<span class="built_in">type</span>(get_data)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;我的名字是：&#x27;</span> + get_data.name)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;我的班级是：&#x27;</span> + get_data.class_name)</span><br></pre></td></tr></table></figure>

<p>涉及多表查询的内连接查询和外连接查询：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 内连接</span></span><br><span class="line">get_data = session.query(mytable).join(myclass).<span class="built_in">filter</span>(mytable.class_name == <span class="string">&#x27;三年级二班&#x27;</span>).<span class="built_in">all</span>()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;数据类型是：&#x27;</span> + <span class="built_in">str</span>(<span class="built_in">type</span>(get_data)))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> get_data:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;我的名字是：&#x27;</span> + i.name)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;我的班级是：&#x27;</span> + i.class_name)</span><br><span class="line"><span class="comment"># 外连接</span></span><br><span class="line">get_data = session.query(mytable).outerjoin(</span><br><span class="line">             myclass).<span class="built_in">filter</span>(mytable.class_name == <span class="string">&#x27;三年级二班&#x27;</span>).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>

<p>4、涉及复杂的查询语句，特别涉及多表查询和复杂的查询条件时，可直接执行sql语句：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sql = <span class="string">&#x27;select * from mytable &#x27;</span></span><br><span class="line">session.execute(sql)</span><br><span class="line"><span class="comment"># 如果涉及更新，添加数据，需要session.commit()</span></span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure>


<h4 id="8-综合案例-1"><a href="#8-综合案例-1" class="headerlink" title="8. 综合案例(1)"></a>8. 综合案例(1)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接数据库</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String, DateTime</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">&quot;mysql+pymysql://root:12345678@localhost:3306/my_test?charset=utf8&quot;</span>, echo=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentItem</span>(<span class="params">Base</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;创建数据表方法一&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 表名</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;my_student&#x27;</span></span><br><span class="line">    <span class="comment"># 字段，属性</span></span><br><span class="line">    stu_id = Column(Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    stu_name = Column(String(<span class="number">50</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    stu_age = Column(Integer)</span><br><span class="line">    stu_birth = Column(DateTime)</span><br><span class="line">    stu_class_name = Column(String(<span class="number">50</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>sqlalchemy_test.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"><span class="keyword">from</span> crawl_test.orm <span class="keyword">import</span> Base, engine, StudentItem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">get_session = sessionmaker(bind=engine)  <span class="comment"># 可设置autocommit=True  对当前session进行设置</span></span><br><span class="line">session = get_session()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_table</span>(<span class="params">engine</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;创建表&quot;&quot;&quot;</span></span><br><span class="line">    Base.metadata.create_all(engine)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_one</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;向表中添加数据&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        new_data = StudentItem(stu_name=<span class="string">&#x27;王五&#x27;</span>, stu_age=<span class="number">30</span>, stu_birth=<span class="string">&#x27;2005-06-09&#x27;</span>, stu_class_name=<span class="string">&#x27;六年级4班&#x27;</span>)</span><br><span class="line">        session.add(new_data)</span><br><span class="line">        session.commit()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;向表中添加单条数据成功&#x27;</span>)</span><br><span class="line">        session.close()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        session.rollback()</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">f&#x27;向数据库添加数据失败 ：<span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query_one</span>(<span class="params">stu_id=<span class="literal">None</span>, stu_name=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;根据id或者名字查询,返回字典&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> stu_id:</span><br><span class="line">            single_stu = session.query(StudentItem).filter_by(stu_id=stu_id).first()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            single_stu = session.query(StudentItem).filter_by(stu_name=stu_name).first()</span><br><span class="line">        single_stu_dict = single_stu.__dict__</span><br><span class="line">        <span class="keyword">return</span> single_stu_dict</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        session.rollback()</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">f&#x27;数据库查询失败 ：<span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        session.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query_all</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;查询所有数据，返回一个列表&quot;&quot;&quot;</span></span><br><span class="line">    stu_data_list = []</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        stu_data = session.query(StudentItem).<span class="built_in">all</span>()</span><br><span class="line">        <span class="comment"># 遍历对象的列表，并转换成字典</span></span><br><span class="line">        <span class="keyword">for</span> stu <span class="keyword">in</span> stu_data:</span><br><span class="line">            stu_dict = stu.__dict__</span><br><span class="line">            stu_data_list.append(stu_dict)</span><br><span class="line">        <span class="keyword">return</span> stu_data_list</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        session.rollback()</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">f&#x27;数据库查询失败 ：<span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        session.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_stu_data</span>(<span class="params">stu_id=<span class="literal">None</span>, stu_name=<span class="literal">None</span>, stu_data_dict=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;根据id或者名字来修改数据&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> stu_id:</span><br><span class="line">            result = session.query(StudentItem).filter_by(stu_id=stu_id).update(stu_data_dict)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result = session.query(StudentItem).filter_by(stu_name=stu_name).update(stu_data_dict)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;修改成功&#x27;</span>, result)</span><br><span class="line">        session.commit()</span><br><span class="line">        session.close()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        session.rollback()</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">f&#x27;修改数据失败 ：<span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_stu_data</span>(<span class="params">stu_id=<span class="literal">None</span>, stu_name=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;删除一个数据&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> stu_id:</span><br><span class="line">            ret = session.query(StudentItem).<span class="built_in">filter</span>(StudentItem.stu_id == stu_id).delete()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ret = session.query(StudentItem).<span class="built_in">filter</span>(StudentItem.stu_name == stu_name).delete()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;删除成功&#x27;</span>, ret)</span><br><span class="line">        session.commit()</span><br><span class="line">        session.close()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        session.rollback()</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">f&#x27;删除数据失败 ：<span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># create_table(engine)</span></span><br><span class="line">    <span class="comment"># 增加一个数据</span></span><br><span class="line">    <span class="comment"># add_one()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查询：根据id或者姓名查询单个数据</span></span><br><span class="line">    stu_data = query_one(stu_id=<span class="number">6</span>)</span><br><span class="line">    <span class="built_in">print</span>(stu_data[<span class="string">&#x27;stu_name&#x27;</span>])</span><br><span class="line">    <span class="comment"># 查询：所有数据</span></span><br><span class="line">    <span class="comment"># stu_data_list = query_all()</span></span><br><span class="line">    <span class="comment"># for stu_data in stu_data_list:</span></span><br><span class="line">    <span class="comment">#     print(stu_data)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 更新数据</span></span><br><span class="line">    <span class="comment"># data_dict = &#123;</span></span><br><span class="line">    <span class="comment">#     StudentItem.stu_age: 42,</span></span><br><span class="line">    <span class="comment">#     StudentItem.stu_name: &#x27;张君宝&#x27;</span></span><br><span class="line">    <span class="comment"># &#125;</span></span><br><span class="line">    <span class="comment"># update_stu_data(stu_name=&#x27;张无忌&#x27;, stu_data_dict=data_dict)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除数据</span></span><br><span class="line">    <span class="comment"># delete_stu_data(stu_id=3)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="9-综合案例（2）"><a href="#9-综合案例（2）" class="headerlink" title="9. 综合案例（2）"></a>9. 综合案例（2）</h4><p>1、创建一个schema:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Base = declarative_base() <span class="comment">#生成orm基类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlchemyTest</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;tbSqlAlchemyTest&#x27;</span> <span class="comment">#这里不用加上dbo.前缀，默认已经有了</span></span><br><span class="line"></span><br><span class="line">    TestName = Column(String(<span class="number">256</span>), primary_key=<span class="literal">True</span>)</span><br><span class="line">    TestNumber = Column(INTEGER)</span><br><span class="line">    </span><br><span class="line"><span class="comment">#the table object is a member of a larger collection known as MetaData</span></span><br><span class="line">Base.metadata.create_all(engine) <span class="comment">#通过基类与数据库进行交互创建表结构，此时表内还没有数据</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>还可以在创建class的末尾加上类似于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;User(name=&#x27;%s&#x27;, fullname=&#x27;%s&#x27;, password=&#x27;%s&#x27;)&gt;&quot;</span> % (</span><br><span class="line">                                self.name, self.fullname, self.password)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这个为可选项，只是增加对于表的描述，便于以后测试</p>
<p>向表内加入数据：<br>先创建一个实例：<code>test1 = AlchemyTest(TestName=&#39;user1&#39;, TestNumber=1995)</code></p>
<p>再创建一个会话：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"></span><br><span class="line">Session_class = sessionmaker(bind=engine) <span class="comment">#建立与数据库的会话连接，这里建立的是一个class不是一个实例对象</span></span><br><span class="line">session = Session_class() <span class="comment">#这里创建一个会话实例</span></span><br><span class="line">test1 = AlchemyTest(TestName=<span class="string">&#x27;user1&#x27;</span>, TestNumber=<span class="number">1995</span>)</span><br><span class="line">session.add(test1) <span class="comment">#把要创建的数据对象加入到这个会话中，这个时候是pending状态，添加多个对象使用add_all()</span></span><br><span class="line">session.commit() <span class="comment">#统一提交会话中的操作</span></span><br><span class="line">session.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在提交这个会话之前就可以使用：<code>our_user = session.query(User).filter_by(name=&#39;ed&#39;).first()</code> 来查看刚刚创建的数据<br>在会话提交之前，还可以这样回滚这个会话，使之前flush的内容失效： <code>session.rollback()</code><br>每个session会话才是真正的与数据库的连接</p>
<p>2、建立表与表之间的关系（一对多，多对一）：</p>
<p>多对一：employee对于department是多对一的关系</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Department</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;department&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">30</span>))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;employee&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">30</span>))</span><br><span class="line">    dep_id = Column(Integer, ForeignKey(<span class="string">&#x27;department.id&#x27;</span>))</span><br><span class="line">    department = relationship(<span class="string">&quot;Department&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>一对多：department对于employee是一对多的关系</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Department</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;department&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">30</span>))</span><br><span class="line">    employees = relationship(<span class="string">&quot;Employee&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;employee&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">30</span>))</span><br><span class="line">    dep_id = Column(Integer, ForeignKey(<span class="string">&#x27;department.id&#x27;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>新建一个tbSqlAlchemyTestError的table</strong> 一个test可以有多个error</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlchemyTestError</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;tbSqlAlchemyTestError&#x27;</span></span><br><span class="line"></span><br><span class="line">    errorID = Column(INTEGER, primary_key=<span class="literal">True</span>)</span><br><span class="line">    errorname = Column(String(<span class="number">256</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    TestName = Column(String(<span class="number">256</span>), ForeignKey(<span class="string">&#x27;tbSqlAlchemyTest.TestName&#x27;</span>))<span class="comment">#这里面关联外键使用表的名字而不是类的名字,表与表之间建立联系</span></span><br><span class="line"></span><br><span class="line">    test = relationship(<span class="string">&quot;AlchemyTest&quot;</span>, back_populates=<span class="string">&quot;error&quot;</span>)</span><br><span class="line">    <span class="comment">#告诉ORM,自己这个class与AlchemyTest这个class相关联，并且设定了一个“多对一”的关系</span></span><br><span class="line">    <span class="comment">#*在自己这个类中生成一个test属性，然后在AlchemyTest类中创建一个error属性，与之关联，可以反向查询*</span></span><br><span class="line"></span><br><span class="line">AlchemyTest.error = relationship(<span class="string">&quot;AlchemyTestError&quot;</span>, back_populates=<span class="string">&quot;test&quot;</span>)</span><br><span class="line"><span class="comment">#与上面一个relationship形成双向relationship，意思是在AlchemyTest类中生成一个error属性，然后与AlchemyTestError中的test属性相关联</span></span><br><span class="line"><span class="comment">#所以实际上与上面一个relationship是一样的意思</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>给一对多的关系表插入数据：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">test1 = session.query(AlchemyTest).<span class="built_in">filter</span>(AlchemyTest.TestName == <span class="string">&#x27;user1&#x27;</span>).first() <span class="comment">#首先提取需要加入error的test，这个已经存在</span></span><br><span class="line">test1.error = [AlchemyTestError(errorID=<span class="string">&#x27;553&#x27;</span>, errorname=<span class="string">&#x27;cuowu&#x27;</span>),</span><br><span class="line">               AlchemyTestError(errorID=<span class="string">&#x27;667&#x27;</span>, errorname=<span class="string">&#x27;afsf&#x27;</span>)] <span class="comment">#使用relationship()时建立的error属性来给AlchemyTestError插入数据</span></span><br><span class="line">session.add(test1)</span><br><span class="line">session.commit()stmt</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用query.join()结合两张表来查询数据表数据：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">result = session.query(AlchemyTest).join(AlchemyTestError).<span class="built_in">filter</span>(AlchemyTestError.errorname == <span class="string">&#x27;cuowu&#x27;</span>).first() <span class="comment">#查询AlchemyTest表内的数据，看哪些user有这个error</span></span><br><span class="line"><span class="keyword">if</span> result <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="built_in">print</span>(result.TestName)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>因为这两张表只有一个外键，所以query.join()知道怎么关联这两张表，但是如果没有或者不止一个外键的时候，使用其他的形式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = session.query(AlchemyTest).join((AlchemyTestError, AlchemyTest.TestName==AlchemyTestError.TestName)).first()</span><br></pre></td></tr></table></figure>
<p>这里有一个join的reminder：<br>join : 如果表中有至少一个匹配，则返回行<br>left join : 即使右表中没有匹配，也从左表返回所有的行<br>right join : 即使左表中没有匹配，也从右表返回所有的行<br>full join : 只要其中一个表中存在匹配，就返回行</p>
<p>outerjoin: <code>query.outerjoin(User.addresses) # LEFT OUTER JOIN</code></p>
<p>使用别名：<br>当一个table需要被call多次的时候，使用别名aliased()可以弄清：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name1 = aliased(AlchemyTest)</span><br><span class="line">name2 = aliased(AlchemyTest)</span><br></pre></td></tr></table></figure>

<p>使用subquery()来做子查询：<br>这个例子用于查询每个AlchemyTest的TestName对应了几个error：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">stmt = session.query(AlchemyTestError.TestName, func.count(<span class="string">&#x27;*&#x27;</span>).label(<span class="string">&#x27;errorcount&#x27;</span>)).group_by(AlchemyTestError.TestName).subquery() <span class="comment">#一定要使用subquery()才能使这个临时表生效</span></span><br><span class="line"><span class="comment">#相当于生成了一个临时表，stmt它具有表结构，这个表结构的数据我们通过&quot;c&quot;这个属性来获取</span></span><br><span class="line"><span class="keyword">for</span> user, count <span class="keyword">in</span> session.query(AlchemyTest, stmt.c.errorcount).outerjoin(stmt, AlchemyTest.TestName==stmt.c.TestName).order_by(AlchemyTest.TestName):</span><br><span class="line"><span class="comment">#这里相当于SELECT user FROM AlchemyTest, SELECT count FROM stmt.c.errorcount LEFT OUTER JOIN stmt ON (AlchemyTest.TestName==stmt.c.TestName)</span></span><br><span class="line">    <span class="built_in">print</span>(user.TestName, count)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用exists()：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stmt = exists().where(Address.user_id==User.<span class="built_in">id</span>)</span><br><span class="line"><span class="keyword">for</span> name, <span class="keyword">in</span> session.query(User.name).<span class="built_in">filter</span>(stmt):</span><br><span class="line">     <span class="built_in">print</span>(name)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>一些描述关系的方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">query.<span class="built_in">filter</span>(User.addresses.contains(someaddress))</span><br><span class="line">query.<span class="built_in">filter</span>(User.addresses.<span class="built_in">any</span>(Address.email_address == <span class="string">&#x27;bar&#x27;</span>))</span><br><span class="line">query.<span class="built_in">filter</span>(Address.user.has(name=<span class="string">&#x27;ed&#x27;</span>))</span><br><span class="line">session.query(Address).with_parent(someuser, <span class="string">&#x27;addresses&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>删除数据：<br>删除可以直接使用<code>session.delete()</code><br>但是与之关联的table并没有删除数据，因为SQLAlchemy并没有设定级联删除！！！<br>解决方案：<br>在一对多关系的table里的relationship设定时增加cascade：<br><code>cascade=&quot;all, delete, delete-orphan”</code></p>
<p>建立多对多关系的表结构：<br>例子中有两个tables，分别是博客表和关键字表，一篇博客可以拥有多个关键字，一个关键字也可以对应多篇博客。<br>所以我们要建立一个未映射的关系表：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">post_keywords = Table(<span class="string">&#x27;post_keywords&#x27;</span>, Base.metadata,</span><br><span class="line"><span class="meta">... </span>    Column(<span class="string">&#x27;post_id&#x27;</span>, ForeignKey(<span class="string">&#x27;posts.id&#x27;</span>), primary_key=<span class="literal">True</span>),</span><br><span class="line"><span class="meta">... </span>    Column(<span class="string">&#x27;keyword_id&#x27;</span>, ForeignKey(<span class="string">&#x27;keywords.id&#x27;</span>), primary_key=<span class="literal">True</span>)</span><br><span class="line"><span class="meta">... </span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个表建立的方式与建立一个拥有映射关系的class不同。接下来创建博客表和关键字表分别与这个中间关系表用relationship()关联起来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">BlogPost</span>(<span class="params">Base</span>):</span></span><br><span class="line"><span class="meta">... </span>    __tablename__ = <span class="string">&#x27;posts&#x27;</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">... </span>    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line"><span class="meta">... </span>    user_id = Column(Integer, ForeignKey(<span class="string">&#x27;users.id&#x27;</span>))</span><br><span class="line"><span class="meta">... </span>    headline = Column(String(<span class="number">255</span>), nullable=<span class="literal">False</span>)</span><br><span class="line"><span class="meta">... </span>    body = Column(Text)</span><br><span class="line">...</span><br><span class="line"><span class="meta">... </span>    <span class="comment"># many to many BlogPost&lt;-&gt;Keyword</span></span><br><span class="line"><span class="meta">... </span>    keywords = relationship(<span class="string">&#x27;Keyword&#x27;</span>,</span><br><span class="line"><span class="meta">... </span>                            secondary=post_keywords,</span><br><span class="line"><span class="meta">... </span>                            back_populates=<span class="string">&#x27;posts&#x27;</span>)</span><br><span class="line">...</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, headline, body, author</span>):</span></span><br><span class="line"><span class="meta">... </span>        self.author = author</span><br><span class="line"><span class="meta">... </span>        self.headline = headline</span><br><span class="line"><span class="meta">... </span>        self.body = body</span><br><span class="line">...</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> <span class="string">&quot;BlogPost(%r, %r, %r)&quot;</span> % (self.headline, self.body, self.author)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Keyword</span>(<span class="params">Base</span>):</span></span><br><span class="line"><span class="meta">... </span>    __tablename__ = <span class="string">&#x27;keywords&#x27;</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">... </span>    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line"><span class="meta">... </span>    keyword = Column(String(<span class="number">50</span>), nullable=<span class="literal">False</span>, unique=<span class="literal">True</span>)</span><br><span class="line"><span class="meta">... </span>    posts = relationship(<span class="string">&#x27;BlogPost&#x27;</span>,</span><br><span class="line"><span class="meta">... </span>                         secondary=post_keywords,</span><br><span class="line"><span class="meta">... </span>                         back_populates=<span class="string">&#x27;keywords&#x27;</span>)</span><br><span class="line">...</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, keyword</span>):</span></span><br><span class="line"><span class="meta">... </span>        self.keyword = keyword</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/03/03/python%E5%9F%BA%E7%A1%80/20190303_sqlchemy%E7%9A%84%E4%BD%BF%E7%94%A8/" data-id="ckqd8hruc008rustg3ieh110x" data-title="sqlalchemy的使用" class="article-share-link">Teilen</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python%E5%9F%BA%E7%A1%80/" rel="tag">python基础</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/03/04/python%E5%9F%BA%E7%A1%80/20190304_%E6%93%8D%E4%BD%9Cexcel/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Neuer</strong>
      <div class="article-nav-title">
        
          python操作excel
        
      </div>
    </a>
  
  
    <a href="/2019/03/02/python%E5%9F%BA%E7%A1%80/20190302_sqlalchemy%E7%9A%84%E4%B8%80%E4%BA%9B%E6%A6%82%E5%BF%B5/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Älter</strong>
      <div class="article-nav-title">sqlalchemy的一些概念</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Kategorien</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/python/fastapi/">fastapi</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/flask/">flask</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/python%E5%9F%BA%E7%A1%80/">python基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/python%E6%A1%88%E4%BE%8B/">python案例</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/%E7%88%AC%E8%99%AB/">爬虫</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/python/%E7%88%AC%E8%99%AB/pyppeteer/">pyppeteer</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/%E7%88%AC%E8%99%AB/scrapy/">scrapy</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/%E7%88%AC%E8%99%AB/selenium/">selenium</a></li></ul></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/fastapi/" rel="tag">fastapi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flask/" rel="tag">flask</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pyppeteer/" rel="tag">pyppeteer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python3/" rel="tag">python3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python%E5%9F%BA%E7%A1%80/" rel="tag">python基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python%E6%A1%88%E4%BE%8B/" rel="tag">python案例</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scrapy/" rel="tag">scrapy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/selenium/" rel="tag">selenium</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E9%9B%A8/" rel="tag">代码雨</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%8D%E7%88%AC/" rel="tag">反爬</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%88%AC%E8%99%AB/" rel="tag">爬虫</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/fastapi/" style="font-size: 10px;">fastapi</a> <a href="/tags/flask/" style="font-size: 10px;">flask</a> <a href="/tags/pyppeteer/" style="font-size: 12px;">pyppeteer</a> <a href="/tags/python/" style="font-size: 18px;">python</a> <a href="/tags/python3/" style="font-size: 10px;">python3</a> <a href="/tags/python%E5%9F%BA%E7%A1%80/" style="font-size: 20px;">python基础</a> <a href="/tags/python%E6%A1%88%E4%BE%8B/" style="font-size: 12px;">python案例</a> <a href="/tags/scrapy/" style="font-size: 14px;">scrapy</a> <a href="/tags/selenium/" style="font-size: 12px;">selenium</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E9%9B%A8/" style="font-size: 10px;">代码雨</a> <a href="/tags/%E5%8F%8D%E7%88%AC/" style="font-size: 10px;">反爬</a> <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 16px;">爬虫</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/06/26/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2020/12/02/my_application/20201202_%E5%B0%86excel%E4%B8%AD%E7%9A%84%E5%86%85%E5%AE%B9%E5%AD%98%E5%85%A5mysql/">将excel中的内容存入mysql</a>
          </li>
        
          <li>
            <a href="/2020/10/15/my_application/20201015_%E4%BB%A3%E7%A0%81%E9%9B%A8/">用python实现代码雨（电影黑客帝国里的效果，代码可直接运行）</a>
          </li>
        
          <li>
            <a href="/2020/09/29/spider/20200929_%E4%B8%89%E7%A7%8D%E5%8A%A0%E5%AF%86%E6%96%B9%E5%BC%8F/">三种加密方式 sha1加密、MD5加密、Base64加密 (附H5源码和js源码)</a>
          </li>
        
          <li>
            <a href="/2020/07/15/spider/scrapy/20200715_%20ajaxcrawl/">scrapy源码12 - ajaxcrawl</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 Mr.zhang<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>